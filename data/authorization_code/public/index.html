<!doctype html>
<html>

<head>
    <title>Sound and Mood</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip({
                container: 'body'
            });
        })
        document.onload = function () {
            $('[data-toggle="tooltip"]').tooltip();
        }

    </script>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <style type="text/css">
        a,
        a:hover {
            color: #57b55f;
        }

        #login,
        #loggedin {
            display: none;
        }

        .text-overflow {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 500px;
        }

        .introduction {
            font-weight: 400;
        }

        .navbar {
            border-radius: 0;
        }

        .navbar-text.navbar-right:last-child {
            margin-right: 15px;
        }

        .btn-primary {
            background-color: #57b55f;
            border-color: #46914c;
        }

        .btn-primary:hover,
        .btn-primary:focus {
            background-color: #46914c;
            border-color: #38753d;
        }

        .main-content {
            position: relative;
        }

        #searchResults {
            box-shadow: 5px 5px 8px #55555536;
            max-height: 50vh;
            overflow-y: scroll;
            position: absolute;
            width: 100%;
            z-index: 2;
        }

        #searchResults>a {
            display: flex;
            flex-wrap: wrap;
        }

        #searchResults>a:hover {
            color: #555;
            cursor: pointer;
        }

        #searchResults>a>div {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            justify-content: center;
            padding: 0 1em;
        }

        .classification {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            font-size: 20px;
            margin: 25px 0;
        }

        .classification>div {
            display: flex;
            flex-wrap: wrap;
        }

        .classification>div>div {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            padding: 0 1em;
        }

        #dataviz-graphs {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }

        #dataviz-graphs svg {
            margin: 0 50px;
        }

        #dataviz-graphs>div {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            align-items: center;
        }

        #dataviz-graphs .graph-label {
            font-weight: 600;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: none;
        }

        .custom-tooltip {
            color: #57b55f;
            font-weight: 600;
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted black;
            margin-left: 40px;
        }

        .custom-tooltip:hover {
            cursor: pointer;
        }

        .custom-tooltip .custom-tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: black;
            color: #fff;
            padding: 10px;
            border-radius: 6px;
            margin-left: 10px;
            margin-top: -10px;
            font-weight: 400;
            position: absolute;
            z-index: 1;
        }

        .custom-tooltip:hover .custom-tooltiptext {
            visibility: visible;
        }

        .feature-value {
            color: #57b55f;
        }

        img.loader {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin-left: auto;
            margin-right: auto;
            z-index: 3;
        }
    </style>
    <script src="https://d3js.org/d3.v4.js"></script>
</head>

<body>
    <img src="loading.svg" class="loader" id="loader">
    <script>
        // set the dimensions and margins of the graph
        var margin = { top: 10, right: 20, bottom: 30, left: 60 },
            svg_width = 250 - margin.left - margin.right,
            svg_height = 300 - margin.top - margin.bottom;

        var featureDescriptions = {
            "acousticness": "A confidence measure from 0.0 to 1.0 of whether the track is acoustic where 1.0 represents high confidence.",
            "danceability": "A measure from 0.0 to 1.0 of how suitable a track is for dancing where a value of 0.0 is least danceable and 1.0 is most danceable.",
            "duration_ms": "Duration of track in milliseconds.",
            "energy": "A measure from 0.0 to 1.0 that represents a perceptual measure of intensity and activity.",
            "instrumentalness": "A measure from 0.0 to 1.0 that predicts whether a track contains no vocals.",
            "key": "The key the track is in with integers mapping to pitches using standard Pitch Class notation. Ranges between -1 and 11 where -1 means no key was detected.",
            "liveness": "A measure from 0.0 to 1.0 of the presence of an audience in the recording where a higher value represents an increased probability that the track was performed live.",
            "loudness": "Quality of a sound that is the primary psychological correlate of physical strength (amplitude) measured in decibels (dB).",
            "mode": "Major or minor of the track where 1 represents major and 0 represents minor.",
            "speechiness": "A measure from 0.0 to 1.0 that rerprresents the presence of spoken words in a track where 1.0 means more exclusively speech-like.",
            "tempo": "Speed or pace of a given piece measured in beats per minute (BPM).",
            "time_signature": "Estimated time signature which specifies how many beats are in each bar (or measure). The time signature ranges from 3 to 7 indicating time signatures of \"3/4\", to \"7/\".",
            "valence": "A measure from 0.0 to 1.0 describing the musical positiveness conveyed by a track where 1.0 represents a more positive piece.",
            "end_of_fade_in": "Time, in seconds, at which the track's fade-in period ends.",
            "start_of_fade_out": "Time, in seconds, at which the track's fade-out period starts.",
            "tempo_confidence": "Confidence, from 0.0 to 1.0, of the reliability of the tempo.",
            "time_signature_confidence": "Confidence, from 0.0 to 1.0, of the reliability of the time_signature.",
            "key_confidence": "Confidence, from 0.0 to 1.0, of the reliability of the key.",
            "mode_confidence": " Confidence, from 0.0 to 1.0, of the reliability of the mode."
        };

        function graphBoxPlot(svg, quantiles, x, y, width, val, category) {
            // show the main vertical line
            svg
                .append("line")
                .attr("x1", x(category))
                .attr("x2", x(category))
                .attr("y1", y(quantiles.min))
                .attr("y2", y(quantiles.max))
                .attr("stroke", "black");

            // show the box
            svg
                .append("rect")
                .attr("x", x(category) - width / 2)
                .attr("y", y(quantiles.q3))
                .attr("height", (y(quantiles.q1) - y(quantiles.q3)))
                .attr("width", width)
                .attr("stroke", "black")
                .style("fill", "#57b55f");

            // show median, min and max horizontal lines
            svg
                .selectAll("toto")
                .data([quantiles.min, quantiles.median, quantiles.max])
                .enter()
                .append("line")
                .attr("x1", x(category) - width / 2)
                .attr("x2", x(category) + width / 2)
                .attr("y1", function (d) { return (y(d)) })
                .attr("y2", function (d) { return (y(d)) })
                .attr("stroke", "black");

            svg.append("circle")
                .attr("cx", x(category))
                .attr("cy", y(val))
                .attr('r', '5px')
                .style('fill', 'black');
        }

        function calculateQuantiles(data) {
            var data_sorted = data.sort((a, b) => a - b);
            var q1 = d3.quantile(data_sorted, .25);
            var median = d3.quantile(data_sorted, .5);
            var q3 = d3.quantile(data_sorted, .75);
            var interQuantileRange = q3 - q1;
            var min = q1 - 1.5 * interQuantileRange;
            var max = q1 + 1.5 * interQuantileRange;
            return {
                min: min,
                max: max,
                median: median,
                q1: q1,
                q3: q3,
                interQuantileRange: interQuantileRange
            }
        }

        function graphBoxPlots(data, allData, svg, title, vals, axisLabel, mood) {
            var quantiles = calculateQuantiles(allData);
            var quantiles2 = calculateQuantiles(data);

            var min = Math.min(quantiles.min, quantiles2.min);
            var max = Math.max(quantiles.max, quantiles2.max);

            // show the axes
            var y = d3.scaleLinear()
                .domain([min - quantiles.interQuantileRange, max + quantiles.interQuantileRange])
                .range([svg_height, 0]);
            svg.call(d3.axisLeft(y));

            var x = d3.scaleBand()
                .range([0, svg_width])
                .domain(["All", mood])
                .paddingInner(1)
                .paddingOuter(.5)
            svg.append("g")
                .attr("transform", "translate(0," + svg_height + ")")
                .attr('class', 'axis')
                .call(d3.axisBottom(x))

            var width = 40;     // width of box plot

            graphBoxPlot(svg, quantiles, x, y, width, vals[title], "All");
            graphBoxPlot(svg, quantiles2, x, y, width, vals[title], mood);

            // axis label
            svg.append("text")
                .attr("class", "graph-label")
                .attr("text-anchor", "middle")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (svg_height / 2))
                .attr("dy", "1em")
                .attr("font-family", "sans-serif")
                .attr("fill", "black")
                .attr("transform", "rotate(-90)")
                .text(axisLabel);
        }

        function makeGraphs(vals, mood) {
            removeAllChildNodes(document.getElementById("dataviz-graphs"));
            d3.csv("./mood_data.csv", function (data) {
                var variables = Object.keys(featureDescriptions);
                var axisLabels = {
                    "acousticness": "",
                    "danceability": "",
                    "duration_ms": "milliseconds",
                    "energy": "",
                    "instrumentalness": "",
                    "key": "",
                    "liveness": "",
                    "loudness": "decibels (dB)",
                    "mode": "",
                    "speechiness": "",
                    "tempo": "beats per minute (BPM)",
                    "time_signature": "beats in each bar",
                    "valence": "",
                    "end_of_fade_in": "seconds",
                    "start_of_fade_out": "seconds",
                    "tempo_confidence": "",
                    "time_signature_confidence": "",
                    "key_confidence": "",
                    "mode_confidence": ""
                };
                // only graphs the data that is classified as the given mood
                data1 = data.filter(function (d) {
                    if (d.mood == mood) return true;
                    return false;
                })
                variables.forEach(function (v) {
                    var selectedData = data1.map((function (d) { return d[v]; }));
                    var allData = data.map((function (d) { return d[v]; }));
                    var graphs = document.getElementById("dataviz-graphs");
                    var svgContainer = document.createElement("div");
                    svgContainer.id = "graph-" + v;
                    graphs.appendChild(svgContainer);

                    var tooltip = document.createElement("div");
                    tooltip.setAttribute("class", "custom-tooltip");
                    tooltip.innerHTML = v;
                    var tooltipText = document.createElement("span");
                    tooltipText.setAttribute("class", "custom-tooltiptext");
                    tooltipText.innerHTML = featureDescriptions[v] + " The " + v + " for this song is <b class='feature-value'>" + vals[v] + "</b>.";
                    tooltip.appendChild(tooltipText);
                    svgContainer.appendChild(tooltip);

                    var svg = d3.select("#graph-" + v)
                        .append("svg")
                        .attr("width", svg_width + margin.left + margin.right)
                        .attr("height", svg_height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform",
                            "translate(" + margin.left + "," + margin.top + ")");
                    graphBoxPlots(selectedData, allData, svg, v, vals, axisLabels[v], mood);
                })
            })
        }
    </script>
    <div id="login">
        <nav class="navbar navbar-inverse">
            <a class="navbar-brand" href="">Sound and Mood</a>
        </nav>
        <div class="container">
            <h1>Welcome to Sound and Mood</h1>
            <h3 class="introduction">We're investigating how audio features affect the mood of a song.</h3>
            <h3 class="introduction">Here's the list of audio features we utilized:</h3>
            <span>
                <ul>
                    <li><i>Acousticness</i>: A confidence measure from 0.0 to 1.0 of whether the track is acoustic where
                        1.0 represents high confidence.</li>
                    <li><i>Danceability</i>: A measure from 0.0 to 1.0 of how suitable a track is for dancing where a
                        value of 0.0 is least danceable and 1.0 is most danceable.</li>
                    <li><i>Duration</i>: Duration of track in milliseconds.</li>
                    <li><i>Energy</i>: A measure from 0.0 to 1.0 that represents a perceptual measure of intensity and
                        activity.</li>
                    <li><i>Instrumentalness</i>: A measure from 0.0 to 1.0 that predicts whether a track contains no
                        vocals. </li>
                    <li><i>Key</i>: The key the track is in with integers mapping to pitches using standard Pitch Class
                        notation. Ranges between -1 and 11 where -1 means no key was detected.</li>
                    <li><i>Liveness</i>: A measure from 0.0 to 1.0 of the presence of an audience in the recording where
                        a higher value
                        represents an increased probability that the track was performed live.</li>
                    <li><i>Loudness</i>: Quality of a sound that is the primary psychological correlate of physical
                        strength
                        (amplitude) measured in decibels (dB).</li>
                    <li><i>Mode</i>: Major or minor of the track where 1 represents major and 0 represents minor.</li>
                    <li><i>Speechiness</i>: A measure from 0.0 to 1.0 that rerprresents the presence of spoken words in
                        a track where 1.0 means more exclusively speech-like. </li>
                    <li><i>Tempo</i>: Speed or pace of a given piece measured in beats per minute (BPM).</li>
                    <li><i>Time Signature</i>: Estimated time signature which specifies how many beats are in each bar
                        (or measure). The time signature ranges from 3 to 7 indicating time signatures of "3/4", to
                        "7/4".</li>
                    <li><i>Valence</i>: A measure from 0.0 to 1.0 describing the musical positiveness conveyed by a
                        track where 1.0 represents a more positive piece.</li>
                    <li><i>End of Fade In</i>: Time, in seconds, at which the track's fade-in period ends.</li>
                    <li><i>Start of Fade Out</i>: Time, in seconds, at which the track's fade-out period starts.</li>
                    <li><i>Tempo Confidence</i>: Confidence, from 0.0 to 1.0, of the reliability of the tempo.</li>
                    <li><i>Time Signature Confidence</i>: Confidence, from 0.0 to 1.0, of the reliability of the
                        time_signature.</li>
                    <li><i>Key Confidence</i>: Confidence, from 0.0 to 1.0, of the reliability of the key.</li>
                    <li><i>Mode Confidence</i>: Confidence, from 0.0 to 1.0, of the reliability of the mode.</li>
                </ul>
            </span>
            <h3 class="introduction">For more information, check out the <a
                    href="https://developer.spotify.com/documentation/web-api/reference/#/operations/get-several-audio-features"
                    target="_blank">Spotify Web API</a>.</h3>
            <h2>Get Started Here!</h2>
            <a href="/login" class="btn btn-primary">Log in with Spotify</a>
        </div>
    </div>
    <div id="loggedin">
        <div id="user-navbar">
        </div>
        <div class="container">
            <div id="user-profile">
            </div>
            <!-- <div id="oauth">
            </div> -->
            <!-- <button class="btn btn-default" id="obtain-new-token">Obtain new token using the refresh token</button> -->
        </div>
    </div>
    <div id="dataviz" class="container">
        <h4 id="dataviz-header"></h4>
        <div id="dataviz-graphs"></div>
    </div>

    <script id="user-navbar-template" type="text/x-handlebars-template">
        <nav class="navbar navbar-inverse">
            <a class="navbar-brand" href="">Sound and Mood</a>
            <p class="navbar-text navbar-right">Signed in as <a href="{{external_urls.spotify}}" class="navbar-link" target="_blank">{{display_name}}</a></a></p>
        </nav>
    </script>

    <script id="user-profile-template" type="text/x-handlebars-template">
        <!-- <h1>Logged in as {{display_name}}</h1>
        <div class="media">
            <div class="pull-left">
                <img class="media-object" width="150" src="{{images.0.url}}" />
            </div>
            <div class="media-body">
                <dl class="dl-horizontal">
                    <dt>Display name</dt>
                    <dd class="clearfix">{{display_name}}</dd>
                    <dt>Id</dt>
                    <dd>{{id}}</dd>
                    <dt>Email</dt>
                    <dd>{{email}}</dd>
                    <dt>Spotify URI</dt>
                    <dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
                    <dt>Link</dt>
                    <dd><a href="{{href}}">{{href}}</a></dd>
                    <dt>Profile Image</dt>
                    <dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
                    <dt>Country</dt>
                    <dd>{{country}}</dd>
                </dl>
            </div>
        </div> -->
    <div class="main-content">
        <h3>Search for a song from Spotify and get its mood!</h3>
        <div class="input-group">
            <span class="input-group-addon" id="basic-addon1"><i class="bi bi-search"></i></span>
            <input type="text" id="searchParams" class="form-control">
        </div>
        <div id="searchResults" class="list-group"></div>
        <div id="classification" class="classification"></div>
    </div>
    </script>

    <!-- <script id="oauth-template" type="text/x-handlebars-template">
        <h2>oAuth info</h2>
        <dl class="dl-horizontal">
            <dt>Access token</dt>
            <dd class="text-overflow">{{access_token}}</dd>
            <dt>Refresh token</dt>
            <dd class="text-overflow">{{refresh_token}}</dd>
        </dl>
    </script> -->

    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script>
        // START: TODO
        function createCsv(data) {
            // console.log(data);
            // https://stackoverflow.com/questions/14964035/how-to-export-javascript-array-info-to-csv-on-client-side
            let output = ""
            data.forEach(function (row) {
                output += row.join(",") + "\r\n";
            });
            console.log(output)

            // https://seegatesite.com/tutorial-read-and-write-csv-file-with-javascript/
            let csvData = new Blob([output], {
                type: 'text/csv'
            });
            let csvUrl = URL.createObjectURL(csvData);
            let hiddenElement = document.createElement('a');
            hiddenElement.href = csvUrl;
            hiddenElement.target = '_blank';
            hiddenElement.download = "mood_data.csv";
            hiddenElement.click();
        }

        function getData(access_token) {
            const columns = {
                "playlist": [
                    "playlist_id",
                    "playlist_owner",
                    "playlist",
                ],
                "track": [
                    "id",
                    "name"
                ],
                "features": [
                    "acousticness",
                    "danceability",
                    "duration_ms",
                    "energy",
                    "instrumentalness",
                    "key",
                    "liveness",
                    "loudness",
                    "mode",
                    "speechiness",
                    "tempo",
                    "time_signature",
                    "valence",
                ],
                "analysis": [
                    "key_confidence",
                    "mode_confidence",
                    "tempo_confidence",
                    "time_signature_confidence",
                    "end_of_fade_in",
                    "start_of_fade_out"
                ]
            }
            let headers = []
            columns.playlist.forEach(e => {
                headers.push(e)
            })
            columns.track.forEach(e => {
                headers.push(e)
            })
            columns.features.forEach(e => {
                headers.push(e)
            })
            columns.analysis.forEach(e => {
                headers.push(e)
            })
            headers.push("mood")
            const data = [
                headers
            ];

            const playlists_To_Mood = {
                "37i9dQZF1DXdPec7aLTmlC": "Happy",
                // https://open.spotify.com/playlist/37i9dQZF1DWSqBruwoIXkA?si=b51221f0e90a45e0
                "37i9dQZF1DWSqBruwoIXkA": "Sad",
                // https://open.spotify.com/playlist/37i9dQZF1DWXLSRKeL7KwM?si=a6a0b9c997f84fc1
                "37i9dQZF1DWXLSRKeL7KwM": "Energetic",
                // https://open.spotify.com/playlist/37i9dQZF1DX6VdMW310YC7?si=ab7c9226c69d4661
                "37i9dQZF1DX6VdMW310YC7": "Chill",
                // https://open.spotify.com/playlist/37i9dQZF1DX4mWCZw6qYIw?si=97bf46da837c4020
                "37i9dQZF1DX4mWCZw6qYIw": "Angry",

                // https://open.spotify.com/playlist/37i9dQZF1DWW2hj3ZtMbuO?si=a37e21ffa02c4183
                "37i9dQZF1DWW2hj3ZtMbuO": "Sad",
                // https://open.spotify.com/playlist/37i9dQZF1DX0vHZ8elq0UK?si=8627418227c14602
                "37i9dQZF1DX0vHZ8elq0UK": "Energetic",
                // https://open.spotify.com/playlist/37i9dQZF1DX6xZZEgC9Ubl?si=b064e10b1dfc4efa
                "37i9dQZF1DX6xZZEgC9Ubl": "Sad",
                // https: //open.spotify.com/playlist/37i9dQZF1DWX83CujKHHOn?si=b36dc80bde7b4986
                "37i9dQZF1DWX83CujKHHOn": "Sad",
                "37i9dQZF1DWSf2RDTDayIx": "Happy",
            }

            // Get playlist.
            // console.log(Object.entries(playlists_To_Mood))
            let delay = 500
            let playlists = Object.entries(playlists_To_Mood)
            playlists.forEach((playlist, pi) => {
                let playlist_id = playlist[0]
                setTimeout(function () {
                    $.ajax({
                        url: 'https://api.spotify.com/v1/playlists/' + playlist_id,
                        headers: {
                            'Authorization': 'Bearer ' + access_token
                        },
                        success: function (response) {
                            let numTracks = response["tracks"]["items"].length
                            let playlistName = response["name"].replaceAll(',', ' ')
                            let playlistOwner = response["owner"]["display_name"].replaceAll(',', ' ')
                            let playlistId = response["id"]
                            response["tracks"]["items"].forEach((item, i) => {
                                let track_id = item["track"]["id"]
                                let row = []
                                row.push(playlistId)
                                row.push(playlistOwner)
                                row.push(playlistName)
                                columns.track.forEach(col => {
                                    if (col == "name") {
                                        row.push(item["track"][col].replaceAll(',', ' '))
                                    } else {
                                        row.push(item["track"][col])
                                    }
                                });

                                // Get Audio Features.
                                setTimeout(function () {
                                    $.ajax({
                                        url: 'https://api.spotify.com/v1/audio-features/' + track_id,
                                        headers: {
                                            'Authorization': 'Bearer ' + access_token
                                        },
                                        success: function (response) {
                                            columns.features.forEach(col => {
                                                row.push(response[col])
                                            });

                                            // Get Audio Analysis
                                            setTimeout(function () {
                                                $.ajax({
                                                    url: 'https://api.spotify.com/v1/audio-analysis/' + track_id,
                                                    headers: {
                                                        'Authorization': 'Bearer ' + access_token
                                                    },
                                                    success: function (response) {
                                                        let analysis = response["track"]
                                                        columns.analysis.forEach(col => {
                                                            row.push(analysis[col])
                                                        });
                                                        row.push(playlists_To_Mood[playlist_id])

                                                        console.log(row)
                                                        data.push(row)
                                                        if (i == numTracks - 1 && pi == playlists.length - 1) {
                                                            createCsv(data)
                                                        }
                                                    }
                                                });
                                            }, delay * i * (pi + 1));
                                        }
                                    });
                                }, delay * i * (pi + 1));
                            });
                        }
                    });
                }, delay * pi);
            });
        }
        // END: TODO

        (function () {

            /**
             * Obtains parameters from the hash of the URL
             * @return Object
             */
            function getHashParams() {
                var hashParams = {};
                var e, r = /([^&;=]+)=?([^&;]*)/g,
                    q = window.location.hash.substring(1);
                while (e = r.exec(q)) {
                    hashParams[e[1]] = decodeURIComponent(e[2]);
                }
                return hashParams;
            }

            var navbarSource = document.getElementById('user-navbar-template').innerHTML,
                navbarTemplate = Handlebars.compile(navbarSource),
                navbarPlaceholder = document.getElementById('user-navbar');

            var userProfileSource = document.getElementById('user-profile-template').innerHTML,
                userProfileTemplate = Handlebars.compile(userProfileSource),
                userProfilePlaceholder = document.getElementById('user-profile');

            // var oauthSource = document.getElementById('oauth-template').innerHTML,
            //     oauthTemplate = Handlebars.compile(oauthSource),
            //     oauthPlaceholder = document.getElementById('oauth');

            var params = getHashParams();

            var access_token = params.access_token,
                refresh_token = params.refresh_token,
                error = params.error;

            if (error) {
                alert('There was an error during the authentication');
            } else {
                if (access_token) {
                    // render oauth info
                    // oauthPlaceholder.innerHTML = oauthTemplate({
                    //     access_token: access_token,
                    //     refresh_token: refresh_token
                    // });

                    $.ajax({
                        url: 'https://api.spotify.com/v1/me',
                        headers: {
                            'Authorization': 'Bearer ' + access_token
                        },
                        success: function (response) {
                            userProfilePlaceholder.innerHTML = userProfileTemplate(response);
                            navbarPlaceholder.innerHTML = navbarTemplate(response);
                            $('#login').hide();
                            $('#loggedin').show();
                            // document.getElementById('searchParams').addEventListener('click', function () {
                            //     removeAllChildNodes(document.getElementById('classification'))
                            // })

                            document.getElementById('searchParams').addEventListener('input', function () {
                                search();
                            });
                        }
                    });
                    // getData(access_token);
                } else {
                    // render initial screen
                    $('#login').show();
                    $('#loggedin').hide();
                }

                function search() {
                    var results = [];
                    let searchValue = document.getElementById('searchParams').value;
                    if (searchValue) {
                        $.ajax({
                            url: 'https://api.spotify.com/v1/search',
                            data: {
                                'q': searchValue,
                                'type': 'track',
                                'limit': '10'
                            },
                            type: 'GET',
                            headers: {
                                'Authorization': 'Bearer ' + access_token
                            },
                            success: function (response) {
                                response["tracks"]["items"].forEach((song, i) => {
                                    console.log(song);
                                    var resultItem = document.createElement("a");
                                    resultItem.classList.add('list-group-item');
                                    resultItem.classList.add('list-group-item-action');

                                    let allArtists = "";
                                    song["artists"].forEach((artists, i) => {
                                        if (i > 0) allArtists += ", ";
                                        allArtists += artists["name"];
                                    });

                                    var img = document.createElement("img");
                                    img.src = song["album"]["images"][0].url;
                                    img.style.height = "4em";
                                    resultItem.appendChild(img);

                                    var textDiv = document.createElement("div");
                                    resultItem.appendChild(textDiv);

                                    var songTitle = document.createElement("span");
                                    songTitle.innerHTML = song["name"] + "<b>" + (song["explicit"] ? " E" : "") + "</b>";
                                    textDiv.appendChild(songTitle);

                                    var songArtist = document.createElement("span");
                                    songArtist.classList.add("text-muted");
                                    songArtist.appendChild(document.createTextNode(allArtists));
                                    textDiv.appendChild(songArtist);

                                    resultItem.addEventListener('click', function () {
                                        getSongAudioFeatures(song);
                                    })
                                    results.push(resultItem);
                                });
                                const searchResultsDiv = document.getElementById("searchResults");
                                searchResultsDiv.innerHTML = "";
                                results.forEach(el => {
                                    searchResultsDiv.appendChild(el);
                                })
                            }
                        });
                    } else {
                        document.getElementById("searchResults").innerHTML = "";
                    }
                }

                function getSongAudioFeatures(song) {
                    const columns = {
                        "features": [
                            "acousticness",
                            "danceability",
                            "duration_ms",
                            "energy",
                            "instrumentalness",
                            "key",
                            "liveness",
                            "loudness",
                            "speechiness",
                            "tempo",
                            "valence",
                        ],
                        "analysis": [
                            "key_confidence",
                            "mode_confidence",
                            "tempo_confidence",
                            "time_signature_confidence",
                            "end_of_fade_in",
                            "start_of_fade_out"
                        ]
                    }
                    removeAllChildNodes(document.getElementById("searchResults"));
                    searchBar = document.getElementById('searchParams');
                    searchBar.readOnly = true;
                    var loader = document.getElementById("loader");
                    loader.style.display = "block";
                    $.ajax({
                        url: 'https://api.spotify.com/v1/audio-features',
                        data: {
                            'ids': song['id'],
                        },
                        type: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + access_token
                        },
                        success: function (response) {
                            const features = response['audio_features'][0];
                            var compiledData = {};
                            columns.features.forEach(col => {
                                compiledData[col] = features[col];
                            })
                            console.log(compiledData)
                            $.ajax({
                                url: 'https://api.spotify.com/v1/audio-analysis/' + song['id'],
                                headers: {
                                    'Authorization': 'Bearer ' + access_token
                                },
                                success: function (response) {
                                    let analysis = response["track"];
                                    columns.analysis.forEach(col => {
                                        compiledData[col] = analysis[col];
                                    });
                                    console.log(compiledData)
                                    $.ajax({
                                        url: '/model',
                                        data: compiledData,
                                        success: function (response) {
                                            loader.style.display = "none";
                                            searchBar.readOnly = false;
                                            searchBar.value = ""
                                            classification = document.getElementById('classification');
                                            removeAllChildNodes(classification);

                                            let allArtists = "";
                                            song["artists"].forEach((artists, i) => {
                                                if (i > 0) allArtists += ", ";
                                                allArtists += artists["name"];
                                            });

                                            var songDiv = document.createElement("div");
                                            classification.appendChild(songDiv);

                                            var img = document.createElement("img");
                                            img.src = song["album"]["images"][0].url;
                                            img.style.height = "6em";
                                            songDiv.appendChild(img);

                                            var textDiv = document.createElement("div");
                                            songDiv.appendChild(textDiv);

                                            var pred = document.createElement("p");
                                            pred.appendChild(document.createTextNode(' Classification: ' + response.substring(2, response.length - 3)));
                                            pred.style.fontWeight = "bold";
                                            textDiv.appendChild(pred);
                                            console.log(response);

                                            var songTitle = document.createElement("span");
                                            songTitle.innerHTML = song["name"] + "<b>" + (song["explicit"] ? " E " : " ") + "</b>";
                                            textDiv.appendChild(songTitle);

                                            var songArtist = document.createElement("span");
                                            songArtist.classList.add("text-muted");
                                            songArtist.appendChild(document.createTextNode(allArtists));
                                            textDiv.appendChild(songArtist);

                                            const mood = response.substring(2, response.length - 3);
                                            var headerDesc = document.getElementById("dataviz-header");
                                            headerDesc.innerHTML = "See how <b>" + song["name"] + "</b> compares to the songs in our training and test data. The boxplot on the left is for all the songs, while the boxplot on the right consists only of songs that were classified as <b>" + mood + "</b>. The black circle indicates the value assigned to each audio feature of <b>" + song["name"] + "</b>. Hover over each feature to get more details.";
                                            makeGraphs(compiledData, mood);
                                        }
                                    });
                                }
                            });
                        }
                    });
                }

                // document.getElementById('obtain-new-token').addEventListener('click', function () {
                //     $.ajax({
                //         url: '/refresh_token',
                //         data: {
                //             'refresh_token': refresh_token
                //         }
                //     }).done(function (data) {
                //         access_token = data.access_token;
                //         oauthPlaceholder.innerHTML = oauthTemplate({
                //             access_token: access_token,
                //             refresh_token: refresh_token
                //         });
                //     });
                // }, false);
            }
        })();

        function removeAllChildNodes(parent) {
            while (parent.firstChild) {
                parent.removeChild(parent.firstChild);
            }
        }
    </script>
</body>

</html>