<!doctype html>
<html>

<head>
    <title>Example of the Authorization Code flow with Spotify</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <style type="text/css">
        #login,
        #loggedin {
            display: none;
        }

        .text-overflow {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 500px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="login">
            <h1>This is an example of the Authorization Code flow</h1>
            <a href="/login" class="btn btn-primary">Log in with Spotify</a>
        </div>
        <div id="loggedin">
            <div id="user-profile">
            </div>
            <div id="oauth">
            </div>
            <button class="btn btn-default" id="obtain-new-token">Obtain new token using the refresh token</button>
        </div>
    </div>

    <script id="user-profile-template" type="text/x-handlebars-template">
        <h1>Logged in as {{display_name}}</h1>
        <div class="media">
            <div class="pull-left">
                <img class="media-object" width="150" src="{{images.0.url}}" />
            </div>
            <div class="media-body">
                <dl class="dl-horizontal">
                    <dt>Display name</dt>
                    <dd class="clearfix">{{display_name}}</dd>
                    <dt>Id</dt>
                    <dd>{{id}}</dd>
                    <dt>Email</dt>
                    <dd>{{email}}</dd>
                    <dt>Spotify URI</dt>
                    <dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
                    <dt>Link</dt>
                    <dd><a href="{{href}}">{{href}}</a></dd>
                    <dt>Profile Image</dt>
                    <dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
                    <dt>Country</dt>
                    <dd>{{country}}</dd>
                </dl>
            </div>
        </div>
        <div class="test">
            <input type="text" id="searchParams">
            <div id="searchResults"></div>
        </div>
        <a href="/model" class="btn btn-primary">Python</a>
    </script>

    <script id="oauth-template" type="text/x-handlebars-template">
        <h2>oAuth info</h2>
        <dl class="dl-horizontal">
            <dt>Access token</dt>
            <dd class="text-overflow">{{access_token}}</dd>
            <dt>Refresh token</dt>
            <dd class="text-overflow">{{refresh_token}}</dd>
        </dl>
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
        // START: TODO
        function createCsv(data) {
            // console.log(data);
            // https://stackoverflow.com/questions/14964035/how-to-export-javascript-array-info-to-csv-on-client-side
            let output = ""
            data.forEach(function (row) {
                output += row.join(",") + "\r\n";
            });
            console.log(output)

            // https://seegatesite.com/tutorial-read-and-write-csv-file-with-javascript/
            let csvData = new Blob([output], {
                type: 'text/csv'
            });
            let csvUrl = URL.createObjectURL(csvData);
            let hiddenElement = document.createElement('a');
            hiddenElement.href = csvUrl;
            hiddenElement.target = '_blank';
            hiddenElement.download = "mood_data.csv";
            hiddenElement.click();
        }

        function getData(access_token) {
            const columns = {
                "playlist": [
                    "playlist_id",
                    "playlist_owner",
                    "playlist",
                ],
                "track": [
                    "id",
                    "name"
                ],
                "features": [
                    "acousticness",
                    "danceability",
                    "duration_ms",
                    "energy",
                    "instrumentalness",
                    "key",
                    "liveness",
                    "loudness",
                    "mode",
                    "speechiness",
                    "tempo",
                    "time_signature",
                    "valence",
                ],
                "analysis": [
                    "key_confidence",
                    "mode_confidence",
                    "tempo_confidence",
                    "time_signature_confidence",
                    "end_of_fade_in",
                    "start_of_fade_out"
                ]
            }
            let headers = []
            columns.playlist.forEach(e => {
                headers.push(e)
            })
            columns.track.forEach(e => {
                headers.push(e)
            })
            columns.features.forEach(e => {
                headers.push(e)
            })
            columns.analysis.forEach(e => {
                headers.push(e)
            })
            headers.push("mood")
            const data = [
                headers
            ];

            const playlists_To_Mood = {
                "37i9dQZF1DXdPec7aLTmlC": "Happy",
                // https://open.spotify.com/playlist/37i9dQZF1DWSqBruwoIXkA?si=b51221f0e90a45e0
                "37i9dQZF1DWSqBruwoIXkA": "Sad",
                // https://open.spotify.com/playlist/37i9dQZF1DWXLSRKeL7KwM?si=a6a0b9c997f84fc1
                "37i9dQZF1DWXLSRKeL7KwM": "Energetic",
                // https://open.spotify.com/playlist/37i9dQZF1DX6VdMW310YC7?si=ab7c9226c69d4661
                "37i9dQZF1DX6VdMW310YC7": "Chill",
                // https://open.spotify.com/playlist/37i9dQZF1DX4mWCZw6qYIw?si=97bf46da837c4020
                "37i9dQZF1DX4mWCZw6qYIw": "Angry",

                // https://open.spotify.com/playlist/37i9dQZF1DWW2hj3ZtMbuO?si=a37e21ffa02c4183
                "37i9dQZF1DWW2hj3ZtMbuO": "Sad",
                // https://open.spotify.com/playlist/37i9dQZF1DX0vHZ8elq0UK?si=8627418227c14602
                "37i9dQZF1DX0vHZ8elq0UK": "Energetic",
                // https://open.spotify.com/playlist/37i9dQZF1DX6xZZEgC9Ubl?si=b064e10b1dfc4efa
                "37i9dQZF1DX6xZZEgC9Ubl": "Sad",
                // https: //open.spotify.com/playlist/37i9dQZF1DWX83CujKHHOn?si=b36dc80bde7b4986
                "37i9dQZF1DWX83CujKHHOn": "Sad",
                "37i9dQZF1DWSf2RDTDayIx": "Happy",
            }

            // Get playlist.
            // console.log(Object.entries(playlists_To_Mood))
            let delay = 500
            let playlists = Object.entries(playlists_To_Mood)
            playlists.forEach((playlist, pi) => {
                let playlist_id = playlist[0]
                setTimeout(function () {
                    $.ajax({
                        url: 'https://api.spotify.com/v1/playlists/' + playlist_id,
                        headers: {
                            'Authorization': 'Bearer ' + access_token
                        },
                        success: function (response) {
                            let numTracks = response["tracks"]["items"].length
                            let playlistName = response["name"].replaceAll(',', ' ')
                            let playlistOwner = response["owner"]["display_name"].replaceAll(',', ' ')
                            let playlistId = response["id"]
                            response["tracks"]["items"].forEach((item, i) => {
                                let track_id = item["track"]["id"]
                                let row = []
                                row.push(playlistId)
                                row.push(playlistOwner)
                                row.push(playlistName)
                                columns.track.forEach(col => {
                                    if (col == "name") {
                                        row.push(item["track"][col].replaceAll(',', ' '))
                                    } else {
                                        row.push(item["track"][col])
                                    }
                                });

                                // Get Audio Features.
                                setTimeout(function () {
                                    $.ajax({
                                        url: 'https://api.spotify.com/v1/audio-features/' + track_id,
                                        headers: {
                                            'Authorization': 'Bearer ' + access_token
                                        },
                                        success: function (response) {
                                            columns.features.forEach(col => {
                                                row.push(response[col])
                                            });

                                            // Get Audio Analysis
                                            setTimeout(function () {
                                                $.ajax({
                                                    url: 'https://api.spotify.com/v1/audio-analysis/' + track_id,
                                                    headers: {
                                                        'Authorization': 'Bearer ' + access_token
                                                    },
                                                    success: function (response) {
                                                        let analysis = response["track"]
                                                        columns.analysis.forEach(col => {
                                                            row.push(analysis[col])
                                                        });
                                                        row.push(playlists_To_Mood[playlist_id])

                                                        console.log(row)
                                                        data.push(row)
                                                        if (i == numTracks - 1 && pi == playlists.length - 1) {
                                                            createCsv(data)
                                                        }
                                                    }
                                                });
                                            }, delay * i * (pi + 1));
                                        }
                                    });
                                }, delay * i * (pi + 1));
                            });
                        }
                    });
                }, delay * pi);
            });
        }
        // END: TODO

        (function () {

            /**
             * Obtains parameters from the hash of the URL
             * @return Object
             */
            function getHashParams() {
                var hashParams = {};
                var e, r = /([^&;=]+)=?([^&;]*)/g,
                    q = window.location.hash.substring(1);
                while (e = r.exec(q)) {
                    hashParams[e[1]] = decodeURIComponent(e[2]);
                }
                return hashParams;
            }

            var userProfileSource = document.getElementById('user-profile-template').innerHTML,
                userProfileTemplate = Handlebars.compile(userProfileSource),
                userProfilePlaceholder = document.getElementById('user-profile');

            var oauthSource = document.getElementById('oauth-template').innerHTML,
                oauthTemplate = Handlebars.compile(oauthSource),
                oauthPlaceholder = document.getElementById('oauth');

            var params = getHashParams();

            var access_token = params.access_token,
                refresh_token = params.refresh_token,
                error = params.error;

            if (error) {
                alert('There was an error during the authentication');
            } else {
                if (access_token) {
                    // render oauth info
                    oauthPlaceholder.innerHTML = oauthTemplate({
                        access_token: access_token,
                        refresh_token: refresh_token
                    });

                    $.ajax({
                        url: 'https://api.spotify.com/v1/me',
                        headers: {
                            'Authorization': 'Bearer ' + access_token
                        },
                        success: function (response) {
                            userProfilePlaceholder.innerHTML = userProfileTemplate(response);
                            $('#login').hide();
                            $('#loggedin').show();
                            document.getElementById('searchParams').addEventListener('input', function () {
                                var ol = document.createElement("ol");
                                let searchValue = document.getElementById('searchParams').value;
                                if (searchValue) {
                                    $.ajax({
                                        url: 'https://api.spotify.com/v1/search',
                                        data: {
                                            'q': searchValue,
                                            'type': 'track',
                                            'limit': '10'
                                        },
                                        type: 'GET',
                                        headers: {
                                            'Authorization': 'Bearer ' + access_token
                                        },
                                        success: function (response) {
                                            response["tracks"]["items"].forEach((song, i) => {
                                                console.log(song);
                                                var li = document.createElement("li");
                                                let allArtists = "";
                                                song["artists"].forEach((artists, i) => {
                                                    if (i > 0) allArtists += ", ";
                                                    allArtists += artists["name"];
                                                });
                                                li.appendChild(document.createTextNode(song["name"] + " by " + allArtists + (song["explicit"] ? " E" : "")));
                                                // li.setAttribute('data-id', song['id']);
                                                li.addEventListener('click', function () {
                                                    getSongAudioFeatures(song['id']);
                                                })
                                                ol.appendChild(li);
                                            });
                                            document.getElementById("searchResults").innerHTML = "";
                                            document.getElementById("searchResults").appendChild(ol);
                                        }
                                    });
                                } else {
                                    document.getElementById("searchResults").innerHTML = "";
                                }
                            });
                        }
                    });
                    // getData(access_token);
                } else {
                    // render initial screen
                    $('#login').show();
                    $('#loggedin').hide();
                }

                function getSongAudioFeatures(id) {
                    $.ajax({
                        url: 'https://api.spotify.com/v1/audio-features',
                        data: {
                            'ids': id,
                        },
                        type: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + access_token
                        },
                        success: function (response) {
                            const vals = response['audio_features'][0];
                            console.log(vals);
                            $.ajax({
                                url: '/model',
                                data: {
                                    acousticness: vals['acousticness'],
                                    danceability: vals['danceability'],
                                    energy: vals['energy'],
                                    instrumentalness: vals['instrumentalness'],
                                    key: vals['key'],
                                    loudness: vals['loudness'],
                                    mode: vals['mode'],
                                    speechiness: vals['speechiness'],
                                    tempo: vals['tempo'],
                                    time_signature: vals['time_signature'],
                                    valence: vals['valence']
                                },
                                success: function (response) {
                                    console.log(response);
                                }
                            });
                        }
                    });
                }

                document.getElementById('obtain-new-token').addEventListener('click', function () {
                    $.ajax({
                        url: '/refresh_token',
                        data: {
                            'refresh_token': refresh_token
                        }
                    }).done(function (data) {
                        access_token = data.access_token;
                        oauthPlaceholder.innerHTML = oauthTemplate({
                            access_token: access_token,
                            refresh_token: refresh_token
                        });
                    });
                }, false);
            }
        })();
    </script>
</body>

</html>